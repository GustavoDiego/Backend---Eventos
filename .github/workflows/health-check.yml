name: Health Check

on:
    schedule:
        # Executa a cada 10 minutos
        - cron: "*/10 * * * *"
    workflow_dispatch: # Permite execu√ß√£o manual

jobs:
    health-check:
        runs-on: ubuntu-latest
        steps:
            - name: Check health endpoint
              run: |
                  echo "üè• Verificando health do servi√ßo..."
                  response=$(curl -s -w "\n%{http_code}" https://backend-eventos-gw6c.onrender.com/api/health)
                  http_code=$(echo "$response" | tail -n1)
                  body=$(echo "$response" | head -n-1)

                  echo "Status HTTP: $http_code"
                  echo "Resposta: $body"

                  if [ "$http_code" -ne 200 ]; then
                    echo "‚ùå Health check falhou com status $http_code"
                    exit 1
                  fi

                  status=$(echo "$body" | grep -o '"status":"ok"' || echo "")
                  if [ -z "$status" ]; then
                    echo "‚ùå Health check n√£o retornou status 'ok'"
                    exit 1
                  fi

                  echo "‚úÖ Servi√ßo est√° saud√°vel!"

            - name: Notify on failure
              if: failure()
              run: |
                  echo "‚ö†Ô∏è O servi√ßo n√£o est√° respondendo corretamente ao health check"
                  echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
